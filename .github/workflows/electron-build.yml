# GitHub Actions workflow for building and releasing TimeTracker Desktop
# Triggers on version tags (v*) and publishes to GitHub Releases
# Includes code signing for Windows and macOS

name: Build & Release Desktop App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # Build for Windows
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: electron/package-lock.json

      - name: Install dependencies
        working-directory: electron
        run: npm ci

      - name: Build Windows installers
        working-directory: electron
        env:
          # Windows Code Signing
          CSC_LINK: ${{ secrets.WINDOWS_CERTIFICATE }}
          CSC_KEY_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
          # GitHub token for publishing
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run build:win

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installers
          path: |
            electron/dist/*.exe
            electron/dist/*.msi
            electron/dist/latest.yml
          retention-days: 5

  # Build for macOS (Intel + Apple Silicon)
  build-macos:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: electron/package-lock.json

      - name: Install dependencies
        working-directory: electron
        run: npm ci

      - name: Prepare macOS signing
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          MACOS_KEYCHAIN_PASSWORD: ${{ secrets.MACOS_KEYCHAIN_PASSWORD }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Import certificate from secrets
          echo -n "$MACOS_CERTIFICATE" | base64 --decode -o $CERTIFICATE_PATH

          # Create temporary keychain
          security create-keychain -p "$MACOS_KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$MACOS_KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$MACOS_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Allow codesign to access keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$MACOS_KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

      - name: Build macOS installers
        working-directory: electron
        env:
          # macOS Code Signing & Notarization
          CSC_LINK: ${{ secrets.MACOS_CERTIFICATE }}
          CSC_KEY_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          # GitHub token for publishing
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run build:mac

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-installers
          path: |
            electron/dist/*.dmg
            electron/dist/*.zip
            electron/dist/latest-mac.yml
          retention-days: 5

  # Build for Linux
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: electron/package-lock.json

      - name: Install dependencies
        working-directory: electron
        run: npm ci

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm

      - name: Build Linux installers
        working-directory: electron
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run build:linux

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-installers
          path: |
            electron/dist/*.AppImage
            electron/dist/*.deb
            electron/dist/*.rpm
            electron/dist/latest-linux.yml
          retention-days: 5

  # Create GitHub Release and publish all artifacts
  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        id: release_notes
        run: |
          cat << EOF > release_notes.md
          ## TimeTracker Desktop v${{ steps.get_version.outputs.VERSION }}
          
          ### Downloads
          
          | Platform | Download | Notes |
          |----------|----------|-------|
          | Windows | \`.exe\` installer | Recommended for most users |
          | Windows | \`.msi\` installer | For enterprise deployment |
          | macOS | \`.dmg\` installer | Universal (Intel + Apple Silicon) |
          | Linux | \`.AppImage\` | Portable, works on most distros |
          | Linux | \`.deb\` | For Debian/Ubuntu |
          | Linux | \`.rpm\` | For Fedora/RHEL |
          
          ### What's New
          
          - System-wide activity tracking across all applications
          - Automatic idle detection with configurable threshold
          - Cloud sync with TimeTracker web app
          - System tray integration for background operation
          - Auto-start on system boot
          - Power management events (sleep/wake/lock/unlock)
          
          ### Installation
          
          1. Download the installer for your platform
          2. Run the installer and follow the prompts
          3. Open TimeTracker Desktop
          4. Go to Sync settings and enter your web app URL and sync token
          5. Start tracking!
          
          ### Auto-Updates
          
          The desktop app will automatically check for updates and notify you when a new version is available.
          
          ### Code Signing
          
          - **Windows**: Signed with EV Code Signing Certificate
          - **macOS**: Signed and notarized by Apple
          
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ steps.get_version.outputs.VERSION }}...HEAD
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: TimeTracker Desktop v${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, 'beta') || contains(steps.get_version.outputs.VERSION, 'alpha') }}
          files: |
            artifacts/windows-installers/*
            artifacts/macos-installers/*
            artifacts/linux-installers/*
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Notify on completion
  notify:
    needs: release
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Send notification
        run: |
          if [ "${{ needs.release.result }}" == "success" ]; then
            echo "✅ Release completed successfully!"
          else
            echo "❌ Release failed. Check the workflow logs for details."
          fi
